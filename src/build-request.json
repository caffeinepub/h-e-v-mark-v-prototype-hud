{
  "kind": "build_request",
  "title": "Fix utility module toggles so they stay enabled (backend module state persistence)",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Fix the backend `toggleModule(moduleName : Text)` implementation so toggling a module actually updates the persistent `modules` state, and `getModuleStates()` reflects the updated values after a toggle.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "They turn on but don't stay on"
        ]
      },
      "acceptanceCriteria": [
        "Calling `toggleModule(\"helmet\")` flips the stored value of `modules.helmet` and subsequent `getModuleStates().helmet` returns the new value.",
        "Toggling any supported module key (`helmet`, `respirator`, `longJump`, `flashlight`, `advancedMedical`, `radiationShield`, `defibrillator`, `shieldBoost`, `hazardSystem`, `moduleSync`) persists and is returned correctly by `getModuleStates()`.",
        "After a successful toggle, a refetch of the `modules` query does not revert the switch back to its prior state."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure the frontend utilities switches remain stable after toggling by relying on the backend-refetched `modules` state (React Query `modules` query) and do not visually revert unless the backend toggle fails.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "They turn on but don't stay on"
        ]
      },
      "acceptanceCriteria": [
        "In the Utilities tab, toggling any module switch stays in the new position after the mutation settles and the `modules` query invalidates/refetches.",
        "If the backend toggle fails, the UI rolls back to the previous state (no permanent mismatch between switch UI and backend `getModuleStates`).",
        "Switches remain correct after navigating away from the Utilities tab and returning (i.e., after re-render and refetch)."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in `backend/main.mo` (no additional backend services).",
    "Do not edit any files under `frontend/src/components/ui` or other `frontend.immutablePaths` entries from SYSTEM_CONTEXT."
  ],
  "nonGoals": [
    "Adding new utility modules beyond the existing module keys already listed in the UI and backend.",
    "Adding third-party real-time sync or WebSocket-based updates."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}